<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>飞机大战 (史诗级)</title>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #111;
            color: #fff;
        }

        #game-container {
            width: 100%;
            height: 100%;
            position: relative;
            background-color: #000;
        }

        #game-canvas {
            width: 100%;
            height: 100%;
            display: none; 
            background-color: #000;
        }

        /* 菜单通用样式 */
        .menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            border: 2px solid #fff;
            border-radius: 10px;
            text-align: center;
            z-index: 10;
        }

        /* 游戏内 UI */
        #score-display, #boss-hp-display {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 2px #000;
            z-index: 5;
            display: none; 
        }
        #boss-hp-display {
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            color: red;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 5px;
            width: 80%;
            text-align: center;
        }

        /* 开火按钮 */
        #fire-button {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 80px;
            height: 80px;
            background-color: rgba(255, 0, 0, 0.5);
            border: 3px solid rgba(255, 255, 255, 0.7);
            border-radius: 50%; 
            z-index: 5;
            display: none;
            -webkit-tap-highlight-color: transparent; 
        }
        #fire-button:active {
            background-color: rgba(255, 0, 0, 0.8); 
        }
    </style>
</head>
<body>

    <div id="game-container">
        
        <div id="start-menu" class="menu">
            <h1>飞机大战</h1>
            <input type="text" id="player-name-input" placeholder="输入你的名字">
            <button id="start-button">开始游戏</button>
            <h3>本地最高分 (Top 10):</h3>
            <ol id="high-score-list"></ol>
        </div>

        <canvas id="game-canvas"></canvas>

        <div id="score-display">得分: 0</div>
        <div id="boss-hp-display" style="display: none;">BOSS 血量: 100</div>
        <button id="fire-button"></button>

        <div id="game-over-menu" class="menu" style="display: none;">
            <h2>游戏结束</h2>
            <p style="font-size: 20px; margin: 15px 0;">
                最终得分: <span id="final-score">0</span>
            </p>
            <button id="restart-button">重新开始</button>
            <button id="main-menu-button">返回主菜单</button>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // === 1. DOM 元素获取 ===
            const canvas = document.getElementById('game-canvas');
            const ctx = canvas.getContext('2d');
            const startMenu = document.getElementById('start-menu');
            const gameOverMenu = document.getElementById('game-over-menu');
            const startButton = document.getElementById('start-button');
            const restartButton = document.getElementById('restart-button');
            const mainMenuButton = document.getElementById('main-menu-button');
            const playerNameInput = document.getElementById('player-name-input');
            const highScoreList = document.getElementById('high-score-list');
            const finalScoreEl = document.getElementById('final-score');
            const scoreDisplay = document.getElementById('score-display');
            const bossHpDisplay = document.getElementById('boss-hp-display');
            const fireButton = document.getElementById('fire-button');

            // === 2. 游戏变量 & 常量 ===
            let player, bullets, enemies, missiles, boss, bossBullets, score, gameLoopId, playerName;
            let gameIsOver = false;
            let isFiring = false;
            let lastEnemySpawn = 0;
            let enemySpawnInterval = 1000; // 敌人生成间隔 (ms)
            const playerSize = { width: 50, height: 50 };
            const enemySize = { width: 50, height: 50 };
            const bossSize = { width: 150, height: 100 };
            
            // BOSS 战常量
            const BOSS_SPAWN_SCORE = 1500;
            const BOSS_MAX_HP = 100;
            const BOSS_SHOT_DAMAGE = 1; // 1发子弹伤害
            const BOSS_FIRE_RATE = 1000; // BOSS发射间隔 (ms)
            const SCATTER_BULLET_COUNT = 8; // 散射子弹数量

            // 敌人 B (高血量) 属性
            let enemyBInitialHP = 3;
            const ENEMY_B_HP_INCREASE_RATE = 0.005; // 每秒增加0.005点血量 (非常慢)

            // 敌人 A (大范围平移) 属性
            let enemyAMoveSpeed = 3; // 初始大范围平移速度
            const ENEMY_A_MAX_OFFSET = 200; // 大范围平移的最大距离

            // 敌人 C (对角线移动) 属性
            const ENEMY_C_DIAGONAL_SPEED = 3;
            
            // 敌人类型的生成概率
            const ENEMY_PROBABILITIES = [
                { type: 'NORMAL', chance: 0.45, img: 'player1.png' },
                { type: 'HOMING', chance: 0.30, img: 'player2.png' },
                { type: 'ENEMY_A', chance: 0.15, img: 'player3.png' },
                { type: 'ENEMY_B', chance: 0.10, img: 'player4.png' }
            ];

            // === 3. 加载贴图 ===
            const images = {};
            const imageSources = {
                player: 'assets/player.png',
                normal: 'assets/player1.png',
                homing: 'assets/player2.png',
                enemyA: 'assets/player3.png',
                enemyB: 'assets/player4.png',
                enemyC: 'assets/player5.png',
                boss: 'assets/boss.png'
            };

            function loadImages(callback) {
                let loadedCount = 0;
                let totalCount = Object.keys(imageSources).length;
                
                for (const key in imageSources) {
                    images[key] = new Image();
                    images[key].onload = () => {
                        loadedCount++;
                        if (loadedCount === totalCount) {
                            callback();
                        }
                    };
                    images[key].onerror = () => {
                        console.error(`Failed to load image: ${imageSources[key]}`);
                        loadedCount++;
                        if (loadedCount === totalCount) {
                            callback();
                        }
                    };
                    images[key].src = imageSources[key];
                }
            }
            
            // === 4. 排行榜 (LocalStorage) ===
            const HIGH_SCORES_KEY = 'planeShooterHighScores';
            function getHighScores() {
                const scores = localStorage.getItem(HIGH_SCORES_KEY);
                return scores ? JSON.parse(scores) : [];
            }
            function saveHighScore(name, score) {
                if (score === 0) return;
                const scores = getHighScores();
                scores.push({ name, score });
                scores.sort((a, b) => b.score - a.score);
                const top10 = scores.slice(0, 10);
                localStorage.setItem(HIGH_SCORES_KEY, JSON.stringify(top10));
            }
            function displayHighScores() {
                const scores = getHighScores();
                highScoreList.innerHTML = '';
                if (scores.length === 0) {
                    highScoreList.innerHTML = '<li>暂无记录</li>';
                } else {
                    scores.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = `${item.name}: ${item.score}`;
                        highScoreList.appendChild(li);
                    });
                }
            }

            // === 5. 游戏状态管理 ===
            displayHighScores();
            startButton.addEventListener('click', () => loadImages(startGame));
            restartButton.addEventListener('click', startGame);
            mainMenuButton.addEventListener('click', () => {
                gameOverMenu.style.display = 'none';
                startMenu.style.display = 'block';
                displayHighScores();
            });

            function startGame() {
                playerName = playerNameInput.value || '匿名玩家';
                
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                // 初始化游戏
                player = { 
                    x: canvas.width / 2 - playerSize.width / 2, 
                    y: canvas.height - playerSize.height - 80,
                    width: playerSize.width, 
                    height: playerSize.height,
                    lastShotTime: 0,
                    fireRate: 250 
                };
                bullets = [];
                enemies = [];
                missiles = [];
                boss = null;
                bossBullets = [];
                score = 0;
                gameIsOver = false;
                lastEnemySpawn = Date.now();
                enemySpawnInterval = 1000;
                enemyBInitialHP = 3; // 重置敌人B血量基数
                enemyAMoveSpeed = 3; // 重置敌人A速度

                // UI
                scoreDisplay.textContent = `得分: 0`;
                startMenu.style.display = 'none';
                gameOverMenu.style.display = 'none';
                canvas.style.display = 'block';
                scoreDisplay.style.display = 'block';
                fireButton.style.display = 'block';
                bossHpDisplay.style.display = 'none';


                if (gameLoopId) {
                    cancelAnimationFrame(gameLoopId);
                }
                gameLoop();
            }

            function triggerGameOver() {
                if (gameIsOver) return;
                gameIsOver = true;
                cancelAnimationFrame(gameLoopId);

                canvas.style.display = 'none';
                scoreDisplay.style.display = 'none';
                fireButton.style.display = 'none';
                bossHpDisplay.style.display = 'none';
                gameOverMenu.style.display = 'block';
                
                finalScoreEl.textContent = score;
                saveHighScore(playerName, score);
            }

            // === 6. 移动端控制 ===
            canvas.addEventListener('touchstart', (e) => e.preventDefault());
            canvas.addEventListener('touchmove', (e) => e.preventDefault());

            function movePlayer(e) {
                if (gameIsOver || !player) return;
                let touch = e.touches[0];
                
                player.x = touch.clientX - player.width / 2;
                player.y = touch.clientY - player.height / 2;

                if (player.x < 0) player.x = 0;
                if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
                if (player.y < 0) player.y = 0;
                if (player.y + player.height > canvas.height) player.y = canvas.height - player.height;
            }
            canvas.addEventListener('touchstart', movePlayer);
            canvas.addEventListener('touchmove', movePlayer);

            fireButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isFiring = true;
            });
            fireButton.addEventListener('touchend', (e) => {
                e.preventDefault();
                isFiring = false;
            });

            // === 7. 游戏主循环 ===
            let lastTime = 0;
            function gameLoop(timestamp) {
                if (gameIsOver) return;
                
                const deltaTime = timestamp - lastTime;
                lastTime = timestamp;

                update(deltaTime / 1000); // 传入秒数
                draw();

                gameLoopId = requestAnimationFrame(gameLoop);
            }

            // === 8. 更新逻辑 (Update) ===
            function update(dt) {
                // 难度/生命值随时间增加
                enemyBInitialHP += ENEMY_B_HP_INCREASE_RATE * dt;
                enemyAMoveSpeed += 0.05 * dt; // 缓慢增加速度

                // 1. 玩家开火
                if (isFiring && (Date.now() - player.lastShotTime > player.fireRate)) {
                    player.lastShotTime = Date.now();
                    bullets.push({
                        x: player.x + player.width / 2 - 2.5,
                        y: player.y,
                        width: 5,
                        height: 15,
                        speed: 10,
                        damage: 1
                    });
                }

                // 2. BOSS 出现逻辑
                const currentBossMultiple = Math.floor(score / BOSS_SPAWN_SCORE);
                if (currentBossMultiple > 0 && currentBossMultiple % 1 === 0 && !boss) {
                    // 确保只触发一次，并且不是 0
                    if (currentBossMultiple * BOSS_SPAWN_SCORE === score) {
                        spawnBoss();
                    }
                }


                // 3. 更新子弹
                for (let i = bullets.length - 1; i >= 0; i--) {
                    bullets[i].y -= bullets[i].speed;
                    if (bullets[i].y < 0) {
                        bullets.splice(i, 1);
                    }
                }
                
                // 4. 生成敌人 (Boss 存在时不生成)
                if (!boss && Date.now() - lastEnemySpawn > enemySpawnInterval) {
                    lastEnemySpawn = Date.now();
                    spawnRandomEnemy();

                    // 增加难度
                    if (enemySpawnInterval > 300) {
                        enemySpawnInterval -= 10;
                    }
                }

                // 5. 更新敌人 (包含各种类型)
                for (let i = enemies.length - 1; i >= 0; i--) {
                    let enemy = enemies[i];

                    // 水平/对角线移动逻辑
                    if (enemy.type === 'ENEMY_A') {
                        // 大范围平移
                        enemy.x += enemy.moveDirection * enemyAMoveSpeed;
                        let currentOffset = enemy.x - enemy.initialX;
                        if (currentOffset > ENEMY_A_MAX_OFFSET) {
                            enemy.moveDirection = -1;
                        } else if (currentOffset < -ENEMY_A_MAX_OFFSET) {
                            enemy.moveDirection = 1;
                        }
                    } else if (enemy.type === 'ENEMY_C') {
                        // 对角线移动
                        enemy.x += enemy.moveDirectionX * ENEMY_C_DIAGONAL_SPEED;
                        enemy.y += ENEMY_C_DIAGONAL_SPEED;
                    }
                    
                    // 垂直下落 (只有 NORMAL, HOMING, A, B 下落)
                    if (enemy.type !== 'ENEMY_C') {
                        enemy.y += enemy.speed;
                    }

                    // HOMING 敌人发射导弹
                    if (enemy.type === 'HOMING' && (Date.now() - enemy.lastMissileShot > enemy.missileRate)) {
                        enemy.lastMissileShot = Date.now();
                        missiles.push(createMissile(enemy));
                    }

                    // 飞出屏幕/边界检测 (ENEMY_C 飞出屏幕也移除)
                    if (enemy.y > canvas.height || enemy.x < -enemy.width || enemy.x > canvas.width) {
                        enemies.splice(i, 1);
                        continue;
                    }

                    // 碰撞检测：敌人 vs 玩家
                    if (checkCollision(player, enemy)) {
                        triggerGameOver();
                    }
                }
                
                // 6. 更新跟踪导弹
                for (let i = missiles.length - 1; i >= 0; i--) {
                    let missile = missiles[i];
                    updateMissile(missile, player);

                    if (missile.y > canvas.height) {
                        missiles.splice(i, 1);
                        continue;
                    }

                    // 碰撞检测：导弹 vs 玩家
                    if (checkCollision(player, missile)) {
                        triggerGameOver();
                    }
                }

                // 7. BOSS 逻辑
                if (boss) {
                    updateBoss(dt);
                }

                // 8. 更新 BOSS 子弹
                for (let i = bossBullets.length - 1; i >= 0; i--) {
                    let bBullet = bossBullets[i];
                    bBullet.x += bBullet.velocityX;
                    bBullet.y += bBullet.velocityY;
                    
                    if (bBullet.y > canvas.height || bBullet.x < 0 || bBullet.x > canvas.width) {
                        bossBullets.splice(i, 1);
                        continue;
                    }

                    // 碰撞检测：BOSS子弹 vs 玩家
                    if (checkCollision(player, bBullet)) {
                        triggerGameOver();
                    }
                }

                // 9. 碰撞检测：玩家子弹 vs (敌人 or 导弹 or Boss)
                for (let i = bullets.length - 1; i >= 0; i--) {
                    let bullet = bullets[i];
                    let bulletRemoved = false;
                    
                    // a. 子弹 vs 敌人/导弹
                    for (let j = enemies.length - 1; j >= 0; j--) {
                        if (checkCollision(bullet, enemies[j])) {
                            // 处理多血量敌人 B
                            enemies[j].health -= bullet.damage;
                            
                            if (enemies[j].health <= 0) {
                                score += 10;
                                enemies.splice(j, 1); // 移除敌人
                            }

                            bullets.splice(i, 1); // 移除子弹
                            bulletRemoved = true;
                            break;
                        }
                    }

                    if (bulletRemoved) continue;

                    for (let j = missiles.length - 1; j >= 0; j--) {
                        if (checkCollision(bullet, missiles[j])) {
                            score += 5; // 击落导弹+5分
                            missiles.splice(j, 1);
                            bullets.splice(i, 1);
                            bulletRemoved = true;
                            break;
                        }
                    }
                    
                    if (bulletRemoved) continue;

                    // b. 子弹 vs BOSS
                    if (boss && checkCollision(bullet, boss)) {
                        boss.health -= bullet.damage;
                        score += 1; // 命中 Boss +1分
                        
                        // 移除子弹
                        bullets.splice(i, 1); 
                        bulletRemoved = true;

                        if (boss.health <= 0) {
                            boss = null; // 移除 Boss
                            score += 100; // 击败奖励
                            bossHpDisplay.style.display = 'none';
                        }
                    }
                }
                
                // 统一更新分数显示
                scoreDisplay.textContent = `得分: ${score}`;
                if (boss) {
                    bossHpDisplay.textContent = `BOSS 血量: ${Math.max(0, boss.health)} / ${BOSS_MAX_HP}`;
                }
            }
            
            // --- 辅助函数 ---

            function spawnRandomEnemy() {
                // 随机选择一个敌人类型
                let rand = Math.random();
                let cumulativeChance = 0;
                let chosenType = null;

                // 新敌人 C 比较特殊，只在 500 分倍数时单独生成
                if (score > 0 && Math.floor(score / 500) % 2 === 1 && enemies.length < 5) {
                     chosenType = 'ENEMY_C';
                } else {
                    for (const { type, chance } of ENEMY_PROBABILITIES) {
                        cumulativeChance += chance;
                        if (rand < cumulativeChance) {
                            chosenType = type;
                            break;
                        }
                    }
                }

                if (!chosenType) return;

                let enemy = {
                    width: enemySize.width,
                    height: enemySize.height,
                    speed: 2 + (score / 1000),
                    type: chosenType,
                    img: images[chosenType.toLowerCase()]
                };

                // 初始化敌人属性
                if (chosenType === 'ENEMY_B') {
                    enemy.health = Math.ceil(enemyBInitialHP);
                } else {
                    enemy.health = 1;
                }
                
                if (chosenType === 'HOMING') {
                    enemy.lastMissileShot = Date.now();
                    enemy.missileRate = 2000;
                }

                if (chosenType === 'ENEMY_A') {
                    enemy.initialX = Math.random() * (canvas.width - enemy.width - ENEMY_A_MAX_OFFSET * 2) + ENEMY_A_MAX_OFFSET;
                    enemy.x = enemy.initialX;
                    enemy.y = -enemy.height;
                    enemy.moveDirection = Math.random() < 0.5 ? -1 : 1;
                } else if (chosenType === 'ENEMY_C') {
                    // 敌人 C: 左上向右下或右上向左下
                    let startRight = Math.random() < 0.5;
                    enemy.x = startRight ? canvas.width - enemy.width : 0;
                    enemy.y = 0;
                    enemy.moveDirectionX = startRight ? -1 : 1;
                } else {
                    enemy.x = Math.random() * (canvas.width - enemy.width);
                    enemy.y = -enemy.height;
                }

                enemies.push(enemy);
            }

            function createMissile(enemy) {
                return {
                    x: enemy.x + enemy.width / 2 - 10,
                    y: enemy.y + enemy.height,
                    width: 20,
                    height: 30,
                    speed: 2.5 + (score / 3000)
                };
            }

            function updateMissile(missile, target) {
                let dx = (target.x + target.width / 2) - (missile.x + missile.width / 2);
                let dy = (target.y + target.height / 2) - (missile.y + missile.height / 2);
                let distance = Math.sqrt(dx * dx + dy * dy) || 1;
                
                missile.x += (dx / distance) * missile.speed;
                missile.y += (dy / distance) * missile.speed;
            }

            function spawnBoss() {
                // 1. 清屏
                enemies = [];
                missiles = [];
                
                // 2. 出现字幕
                ctx.fillStyle = 'yellow';
                ctx.font = '40px Arial';
                ctx.fillText("青云出没！", canvas.width / 2 - 100, canvas.height / 2);
                
                setTimeout(() => {
                    // 3. 初始化 BOSS
                    boss = {
                        x: canvas.width / 2 - bossSize.width / 2,
                        y: 100, // 屏幕中上部分静止
                        width: bossSize.width,
                        height: bossSize.height,
                        health: BOSS_MAX_HP,
                        lastShotTime: Date.now(),
                        type: 'BOSS',
                        img: images.boss
                    };
                    bossHpDisplay.style.display = 'block';
                }, 500); // 延迟出现，给玩家看字幕
            }

            function updateBoss(dt) {
                if (boss.health <= 0) return; // Boss已死

                // 发射散射子弹
                if (Date.now() - boss.lastShotTime > BOSS_FIRE_RATE) {
                    boss.lastShotTime = Date.now();
                    
                    const angleStep = (Math.PI * 2) / SCATTER_BULLET_COUNT;
                    const bossBulletSpeed = 5;

                    for (let i = 0; i < SCATTER_BULLET_COUNT; i++) {
                        let angle = i * angleStep;
                        
                        // 从 Boss 中心发射
                        const startX = boss.x + boss.width / 2;
                        const startY = boss.y + boss.height / 2;

                        bossBullets.push({
                            x: startX,
                            y: startY,
                            width: 15, // BOSS子弹体积大一点
                            height: 15,
                            damage: BOSS_SHOT_DAMAGE,
                            velocityX: Math.cos(angle) * bossBulletSpeed,
                            velocityY: Math.sin(angle) * bossBulletSpeed
                        });
                    }
                }
            }


            // === 9. 绘制逻辑 (Draw) ===
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // 绘制 BOSS 子弹
                ctx.fillStyle = 'red';
                bossBullets.forEach(bBullet => {
                    ctx.fillRect(bBullet.x, bBullet.y, bBullet.width, bBullet.height);
                });

                // 绘制玩家
                if (images.player.complete) {
                    ctx.drawImage(images.player, player.x, player.y, player.width, player.height);
                }

                // 绘制 BOSS
                if (boss && images.boss.complete) {
                    ctx.drawImage(images.boss, boss.x, boss.y, boss.width, boss.height);
                }

                // 绘制敌人
                enemies.forEach(enemy => {
                    if (enemy.img && enemy.img.complete) {
                        ctx.drawImage(enemy.img, enemy.x, enemy.y, enemy.width, enemy.height);
                    }
                    // 绘制敌人 B 的血条 (简化)
                    if (enemy.type === 'ENEMY_B') {
                         ctx.fillStyle = 'lime';
                         ctx.fillRect(enemy.x, enemy.y - 10, enemy.width * (enemy.health / Math.ceil(enemyBInitialHP)), 5);
                    }
                });

                // 绘制子弹
                ctx.fillStyle = '#fff';
                bullets.forEach(bullet => {
                    ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
                });

                // 绘制导弹
                ctx.fillStyle = 'orange';
                missiles.forEach(missile => {
                    ctx.fillRect(missile.x, missile.y, missile.width, missile.height);
                });
            }

            // === 10. 辅助函数 ===
            function checkCollision(rect1, rect2) {
                return rect1.x < rect2.x + rect2.width &&
                       rect1.x + rect1.width > rect2.x &&
                       rect1.y < rect2.y + rect2.height &&
                       rect1.y + rect1.height > rect2.y;
            }

            window.addEventListener('resize', () => {
                if (!gameIsOver) {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                }
            });

        });
    </script>
</body>
</html>
